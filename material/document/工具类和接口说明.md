# 工具类以及接口

主要位于tools包下，包括以下文件：

- exception.py 自定义异常类
-  config.py ，ConfigClass,py 配置文件信息
- calculatingScores.py:计算各个量表得分
- excelUtils.py：处理excel文件工具类
- doc2pdf.py：doc文档转化为pdf文件
- Utils.py:常用的功能接口
- idAssignments.py：自动分配id实现，后期可移动到**Utils**中
- insertCascadechecek.py:插入数据之前进行外键校验

## 接口

### 量表得分计算（calculatingScores.py）

具体得分规则**参见材料中的量表得分标准**。

统一封装在calculatingScores.py，包含自评以及他评得分计算。

```python
'''
伪代码
函数命名：XXX_total_score代表XX量表的计算规则
传递参数：量表DAO类，存储了各个单项的总分
函数流程：数据校验+计算总分
返回参数：total_score(得分), object_flag(校验结果，true不合法，false合法)
'''
def [scale_name]_total_score(scale_object):
    check_valid() #校验对象是否符合规范，非空判断
    cal_score() #计算得分
```

进行某个量表得分计算的时候，首先需要对传入的量表DAO类进行数据校验，包括属性值是否为空等的判断；第二部分进行单个量表的得分计算工作。

## word转pdf（doc2pdf.py）

word文档转化 pdf格式存储，通过**python调用linux命令然后借助libreoffice实现**，所以系统中需要先安装libreoffice（注：不同版本的libreoffice其转化命令是不同的，需要安装指定版本的软件）。

```python
# 接口使用，file为文件流，会将word自动转化为pdf文件并存储
inst = ConvertFileModelField(file)
pdf = inst.get_content()
```

### excel工具类（excelUtils.py）

针对医嘱单上传，将excel文件读取并将每一行封装成一个对象，以对象list形式返回读取的结果。

```python
'''
file:文件流
return：自定义对象(excelObject)列表，一行数据封装成一个对象
'''
excel_object_list = utils.read_excel(file)
```

### 工具类（Utils.py）

Paginator 分页功能实现：

```python
# obj_count总数目条数，obj_perpage每一页条数，pagetag_current当前页 pagetag_dsp_count显示多少页码
paginator = Paginator(obj_count, obj_perpage, pagetag_current, pagetag_dsp_count)
inpatients = inpatients[paginator.obj_slice_start:paginator.obj_slice_end]
# 这个分页器实际上进行数据库读取的时候还是读取所有的记录，只不过在进行后台数据传递前台的时候进行分页读取，所以，并没有进行数据库层面的分页，只是进行了代码逻辑层面的分页
```

```python
# 自动计算病人年龄，根据扫描日期计算
calculate_age_by_scandate(born, scan_date)
```

### 自动分配编号（idAssignments.py）

主要进行编号分配的逻辑，后面可以移动到Utils工具包里面。

```python
# 自动生成病人id，暂时废弃(目前医生制定)
patient_id = patient_Id_assignment()
# 自动分配复扫id，通过session_id自增实现
patient_id, session_id, standard_id = patient_session_id_assignment(patient_id)
# 生成标准id NN_00000XXX_S00X形式
standard_id = generate_standard_id(patient_id,session_id)
```

### 数据插入之前校验（insertCascadeCheck.py）待完善

```python
def insert__saclename_check(object):
    check_isnull(object)//校验量表三个外键是否为空
    check_foreignkey_isvalid(object)//校验三个外键是否合法，即在外键表中是否存在指定的数据
```

## 类

#### HTTP请求返回消息（responseMessage.py）

封装了HTTP请求JSON response 的类.

当我们通过ajax进行请求传递的时候，需要返回response，通过此文件中的类进行response的封装。

```python
# 错误响应以及成功响应
class ErrorMessage():
    def __init__(seflf,message):
        self.message = message
        self.status = -1
class SuccessMessage():
    def __init__(self,message):
        self.message = message
        self.status = 1
```

### 文件配置类（config.py ;configClass.py）

config.py 以及configClass.py。

两个配置文件，configClass主要是配置类，config是基础配置，**后期config中一些配置项可以转移到cofigClass中去，更利于维护**。


